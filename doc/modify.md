指导手册：将 Tic-tac 修改为氘核—重靶散射模型
1. 核心思想与理论框架的转变

1.1 新的物理系统
原始的 Tic-tac 代码用于求解由三个全同或准全同核子（例如 n-p-n 或 n-p-p 系统）构成的三体问题。我们的目标是将其改造为描述氘核（Deuteron, D）与重靶（Heavy Target, T）散射的模型。

在这个新模型中，系统由三个可区分粒子构成：
- 中子 (n)
- 质子 (p)
- 重靶 (T)

我们将氘核（D）视为由中子和质子组成的束缚态，而重靶（T）被近似为无内部结构的单一实体粒子。因此这是一个由三个可区分粒子构成的三体散射问题。

1.2 相互作用势的变化
原系统中只存在一种核子-核子（NN）相互作用势 V_NN。在新系统中，需要引入三种不同的二体相互作用势：
- V_np: 中子-质子相互作用势（可继续复用原有 NN 势模型，例如 chiral_N2LOopt）。
- V_nT: 中子-重靶相互作用势，通常为复数光学势（Optical Potential），虚部用于吸收未显式包含的反应道。
- V_pT: 质子-重靶相互作用势，为光学势并需额外包含库仑相互作用。

1.3 对称性的变化：放弃置换算符
由于 n、p、T 三者可区分，总波函数 Ψ 不再要求在任意两个粒子交换时满足反对称性；因此不能再利用粒子全同性来简化 Faddeev 方程，原来依赖置换算符 P 的化简方案不再适用。

1.4 完整的 Faddeev 方程组
需求解原始的三耦合方程的 Faddeev 方程组，定义三个 Faddeev 分量：
- ψ_np: 描述 n-p 对最后一次相互作用的分量（入射为氘核时的主分量）。
- ψ_nT: 描述 n-T 对最后一次相互作用的分量。
- ψ_pT: 描述 p-T 对最后一次相互作用的分量。

方程组（符号同原文）：
$$
\begin{aligned}
\psi_{np} &= \phi_{np} + G_0(E)\,T_{np}\,(\psi_{nT} + \psi_{pT}) \\
\psi_{nT} &= 0 + G_0(E)\,T_{nT}\,(\psi_{np} + \psi_{pT}) \\
\psi_{pT} &= 0 + G_0(E)\,T_{pT}\,(\psi_{np} + \psi_{nT})
\end{aligned}
$$

初始态 φ_{np} 表示入射的氘核束缚态与自由重靶 T 的组合；φ_{nT} 和 φ_{pT} 为零（不考虑 n-T 或 p-T 的束缚入射）。T 矩阵分别对应 V_{np}, V_{nT}, V_{pT}。

2. 详细代码修改策略（概要）
该改造范围广泛，影响核心模块，建议按如下步骤分阶段实施并保留全面的单元/回归测试。

2.1 第一步：修改全局常量与运动学
目标：支持不同粒子质量和不同二体约化质量。

影响文件（示例）：
- constants.h：增加粒子质量（m_n, m_p, m_T）、电荷 Z_T 等常量。
- General_functions/kinetic_conversion.cpp：重写能量/动量变换函数，增加按粒子对选择的 lab_to_cm_energy(...) 接口，增加 μ_{np}, μ_{nT}, μ_{pT} 的计算与接口。

实现建议：
- 使相关函数接受枚举或标识符（pair_type）来选择对应约化质量/转换规则，而不是假定单一 M_N。

2.2 第二步：实现新的相互作用势
目标：新增中子-靶、质子-靶的光学势，并处理库仑力。

新增/修改文件（示例）：
- Interactions/optical_potential.h, Interactions/optical_potential.cpp：实现 OpticalPotential 类，提供 get_real(r), get_imag(r), get_total(r) 等接口，参数化 Woods–Saxon 型实部与虚部。
- Interactions/potential_model.cpp：扩展以加载并管理三种势模型（V_np, V_nT, V_pT）。
- make_potential_matrix.cpp：在 calculate_potential_matrices_array_in_WP_basis() 中根据当前处理的粒子对选择相应势模型，质子-靶势上叠加库仑势（点电荷或扩展核模型）。

库仑处理建议：
- 在动量空间计算时采用屏蔽库仑或分离长程项的数值策略，并为 V_pT 提供专门处理路径。

2.3 第三步：重构 Faddeev 方程求解器
目标：移除基于全同性的置换算符处理，改写求解器以解三分量耦合系统。

主要改动（示例）：
- 删除/停用 make_permutation_matrix.cpp 及相关调用，清理对 P123 的依赖。
- 修改 solve_faddeev.cpp：重写 solve_faddeev_equation()，把未知向量扩展为
  $$
  X = \begin{pmatrix}\psi_{np} \\ \psi_{nT} \\ \psi_{pT}\end{pmatrix}
  $$
  构造块矩阵线性系统 (I - A) X = B，其中 A 为 3×3 块矩阵：
  $$
  \begin{pmatrix}
  I & -G_0 T_{np} & -G_0 T_{np} \\
  -G_0 T_{nT} & I & -G_0 T_{nT} \\
  -G_0 T_{pT} & -G_0 T_{pT} & I
  \end{pmatrix}
  $$
  右端 B = (φ_{np}, 0, 0)^T。

- 迭代求解器（如 GMRES 或 BiCGStab）需要新的矩阵-向量乘法子程序：给定 X，计算 A*X（可以重用 G0 与 T 在波包基中为对角/块对角的性质来加速）。

2.4 第四步：调整分波基与初始状态
目标：移除基于三个全同粒子的对称化约束，正确生成可区分粒子的基集与初始向量。

影响文件（示例）：
- make_pw_symm_states.cpp：在 construct_3N_pw_states() 中删除对称化与置换约束，对 n-p 对仍按偶奇性（L+S+T）约束处理（若适用），但对 n-T、p-T 不施加同类对称性限制。
- run_organizer.cpp（或项目主流程文件）：新增构造初始向量 B 的函数：
  - 计算氘核束缚态波函数（复用或扩展现有二体求解器）。
  - 将束缚态与自由重靶平面波组合并投影到离散波包基上，构造 φ_{np}；B 的其余两个块置零。

3. 总结
将 Tic-tac 从三核子系统改造为氘核—重靶散射模型是一项系统工程：需放弃粒子同同性约简、引入光学势与库仑处理、重写 Faddeev 求解器以求解块矩阵系统，并相应调整运动学与基构造代码；建议分阶段实现、逐步替换并严格以单元/回归测试验证每一步改变。

4. 后续工作（极化，polarization）
为了在该框架中加入极化观测与极化态：
- 数据结构：在状态描述（state struct/class）中增加自旋极化分量（例如对入射束流与靶的极化向量/张量的参数化）。
- 二体算符：确保 T 矩阵与势在自旋耦合空间中正确展开（包含自旋依赖分量，例如中央、LS、Tensor 等）。
- 初始态：构造极化氘核初态时，按所需极化（向量/张量）对束缚态波函数进行线性组合或使用对应的密度矩阵形式投影到波包基。
- 观测量计算：实现自旋依赖的算符投影与散射振幅计算，从求解得到的 ψ 分量计算极化可观测量（如分析率 A_y、张量极化 T_20 等）。
- 测试：以已知简单模型（例如简单中央势且已知解析极化结果的体系）做基准验证。

实施建议：
- 在实现每一步前先设计好自旋和角动量耦合的数据结构，保持与现有分波基产生接口一致；
- 为极化可观测量编写独立模块，便于在求解器稳定后做逐步验证与比较。

